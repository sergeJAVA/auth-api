<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>–ü–æ—Å—Ç</title>
    <style>
        .header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          background: white;
          padding: 10px 20px;
          box-shadow: 0 2px 5px rgba(0,0,0,0.1);
          position: sticky;
          top: 0;
          z-index: 10;
        }

        .back-btn, .lang-toggle {
          background: #eee;
          border: none;
          padding: 8px 16px;
          border-radius: 6px;
          cursor: pointer;
          font-size: 14px;
        }

        body {
          font-family: sans-serif;
          padding: 20px;
          background: #f4f4f4;
        }

        .post-container {
          max-width: 800px;
          margin: 0 auto;
          background: #fff;
          padding: 20px;
          border-radius: 12px;
          box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .post-img {
          width: 100%;
          border-radius: 10px;
        }

        .post-title {
          font-size: 24px;
          margin-top: 16px;
        }

        .post-author {
          color: #666;
          margin-bottom: 12px;
        }

        .post-desc {
          font-size: 16px;
          margin-bottom: 20px;
        }

        .actions {
          display: flex;
          gap: 20px;
          align-items: center;
          margin-bottom: 20px;
        }

        .comments {
          margin-top: 30px;
        }

        .comment {
          border-top: 1px solid #ddd;
          padding: 10px 0;
        }

        .comment button {
          margin-left: 10px;
          font-size: 12px;
          background: #ffdddd;
          border: none;
          border-radius: 4px;
          cursor: pointer;
        }

        .add-comment {
          margin-top: 20px;
          display: flex;
          gap: 10px;
        }

        .add-comment input {
          flex: 1;
          padding: 8px;
        }

        .add-comment button {
          padding: 8px 16px;
          cursor: pointer;
        }

        .loading {
          text-align: center;
          font-size: 16px;
          animation: fadeIn 1s ease-in-out infinite alternate;
        }

        @keyframes fadeIn {
          from { opacity: 0.5; }
          to { opacity: 1; }
        }
    </style>
</head>
<body>
<div class="header">
    <button class="back-btn" id="backBtn">‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é</button>
    <button class="lang-toggle" id="langToggle">üåê –°–º–µ–Ω–∏—Ç—å —è–∑—ã–∫</button>
</div>

<div class="post-container" id="postContainer">
    <div class="loading" id="loadingText">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–∞...</div>
</div>

<script>
    const postContainer = document.getElementById('postContainer');
    const params = new URLSearchParams(window.location.search);
    const postId = params.get('id');
    const backBtn = document.getElementById('backBtn');
    const langToggle = document.getElementById('langToggle');
    const loadingText = document.getElementById('loadingText');

    let liked = false;
    let post = null;
    let currentUser = null;
    let currentLang = localStorage.getItem('lang') || 'ru';

    const translations = {
      ru: {
        back: "‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é",
        lang: "üåê –°–º–µ–Ω–∏—Ç—å —è–∑—ã–∫",
        author: "–ê–≤—Ç–æ—Ä",
        comments: "üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏",
        placeholder: "–ù–∞–ø–∏—Å–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...",
        add: "–î–æ–±–∞–≤–∏—Ç—å",
        noComments: "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.",
        delete: "–£–¥–∞–ª–∏—Ç—å",
        errorLoading: "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ—Å—Ç–∞.",
        notFound: "–ü–æ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω",
        loading: "–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–∞...",
        deletePost: "–£–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç?"
      },
      en: {
        back: "‚¨ÖÔ∏è Back to Home",
        lang: "üåê Change language",
        author: "Author",
        comments: "üí¨ Comments",
        placeholder: "Write a comment...",
        add: "Add",
        noComments: "No comments yet.",
        delete: "Delete",
        errorLoading: "Failed to load post.",
        notFound: "Post not found",
        loading: "Loading post...",
        deletePost: "Delete this post?"
      }
    };

    function applyTranslationsStatic() {
      const t = translations[currentLang];
      backBtn.textContent = t.back;
      langToggle.textContent = t.lang;
      if (loadingText) loadingText.textContent = t.loading;
    }

    langToggle.onclick = () => {
      currentLang = currentLang === 'ru' ? 'en' : 'ru';
      localStorage.setItem('lang', currentLang);
      applyTranslationsStatic();
      updateUI();
    };

    backBtn.onclick = () => {
      window.location.href = 'main.html';
    };

    async function getCurrentUser() {
      try {
        const res = await fetch('http://localhost:8080/user/info', {
          credentials: 'include'
        });
        if (res.ok) {
          currentUser = await res.json();
        }
      } catch (err) {
        console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
      }
    }

    async function loadPost() {
      applyTranslationsStatic();
      await getCurrentUser();

      try {
        const [postRes] = await Promise.all([
          fetch(`http://localhost:8082/post/${postId}`, { credentials: 'include' }),
          new Promise(resolve => setTimeout(resolve, 100))
        ]);

        post = await postRes.json();

        const imageRes = await fetch(`http://localhost:8086/image/download/${post.title}/${post.id}`, {
          credentials: 'include'
        });
        const blob = await imageRes.blob();
        const imgUrl = URL.createObjectURL(blob);

        post.imageUrl = imgUrl;
        updateUI();
        await fetchLikedStatus();
      } catch (err) {
        console.error(err);
        postContainer.innerHTML = `<p>${translations[currentLang].errorLoading}</p>`;
      }
    }

    function updateUI() {
      const t = translations[currentLang];
      if (!post) {
        postContainer.innerHTML = `<p>${t.notFound}</p>`;
        return;
      }

      postContainer.innerHTML = `
        <img src="${post.imageUrl}" class="post-img" />
        <h1 class="post-title">${post.title}</h1>
        <p class="post-author">${t.author}: ${post.author}</p>
        <p class="post-desc">${post.description}</p>
        <div class="actions">
          <button onclick="toggleLike()" id="likeBtn">‚ù§Ô∏è 0</button>
          <button onclick="loadComments()">${t.comments}</button>
          ${
            currentUser && (currentUser.name === post.author || currentUser.roles.includes('admin'))
              ? `<button onclick="deletePost()" style="background:#ffbbbb; border:none; padding:6px 12px; border-radius:6px; cursor:pointer;">üóëÔ∏è ${t.delete}</button>`
              : ''
          }
        </div>
        <div class="add-comment">
          <input type="text" id="commentInput" placeholder="${t.placeholder}" />
          <button onclick="sendComment()">‚ûï ${t.add}</button>
        </div>
        <div class="comments" id="comments"></div>
      `;

      loadLikeCount();
    }
    async function getUserIdByAuthor(authorName) {
      try {
        const res = await fetch(`http://localhost:8080/user/find/${authorName}`, {
          credentials: 'include'
        });
        if (res.ok) {
          const user = await res.json();
          return user.id; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º userId
        }
      } catch (err) {
        console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ userId');
      }
      return null; // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å userId
    }

    async function sendNotification(data, authorName, content) {
      // –ü–æ–ª—É—á–∞–µ–º userId –≤–ª–∞–¥–µ–ª—å—Ü–∞ –ø–æ—Å—Ç–∞ (–∞ –Ω–µ —Ç–æ–≥–æ, –∫—Ç–æ —Å–æ–≤–µ—Ä—à–∏–ª –¥–µ–π—Å—Ç–≤–∏–µ)
      const userId = await getUserIdByAuthor(authorName);



      if (!userId) {
        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ userId –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è');
        return;
      }

      if (currentUser.name === authorName) {
        return;
      }

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      try {
        await fetch('http://localhost:8087/notifications', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({
            ...data, // –í–∫–ª—é—á–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            userId: userId, // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—É—á–µ–Ω–Ω—ã–π userId –≤–ª–∞–¥–µ–ª—å—Ü–∞ –ø–æ—Å—Ç–∞
            content: content, // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
          }),
        });
      } catch (err) {
        console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è', err);
      }
    }

    async function loadLikeCount() {
      try {
        const res = await fetch(`http://localhost:8083/likes/${postId}/count`, {
          credentials: 'include'
        });
        const count = await res.json();
        document.getElementById('likeBtn').textContent = `‚ù§Ô∏è ${count}`;
      } catch (err) {
        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–∞–π–∫–∏');
      }
    }

    async function fetchLikedStatus() {
      try {
        const res = await fetch(`http://localhost:8083/likes/${postId}/user/liked`, {
          credentials: 'include'
        });
        if (res.ok) {
          liked = await res.json();
          // –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ –º–æ–∂–µ—à—å –ø–æ–¥–∫—Ä–∞—Å–∏—Ç—å –∫–Ω–æ–ø–∫—É:
          document.getElementById('likeBtn').classList.toggle('liked', liked);
        }
      } catch (err) {
        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –ª–∞–π–∫–Ω—É–ª –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', err);
      }
    }

    async function toggleLike() {
      try {
        // —Ä–µ—à–∞–µ–º, —á—Ç–æ –¥–µ–ª–∞–µ–º: —Å—Ç–∞–≤–∏–º –∏–ª–∏ —Å–Ω–∏–º–∞–µ–º
        const isAdding = !liked;
        const method = isAdding ? 'POST' : 'DELETE';

        const res = await fetch(`http://localhost:8083/likes/${postId}`, {
          method,
          credentials: 'include'
        });
        if (!res.ok) {
          console.warn('–õ–∞–π–∫ –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è, —Å—Ç–∞—Ç—É—Å', res.status);
          return;
        }

        // –æ–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ –∏ –Ω–∞ UI
        liked = isAdding;
        loadLikeCount();
        document.getElementById('likeBtn').classList.toggle('liked', liked);

        // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ª–∞–π–∫ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω
        if (isAdding) {
          const notificationData = {
            type: 'LIKE',
            postId: postId,
            userId: currentUser.id
          };
          const content = `${currentUser.name} –ø–æ—Å—Ç–∞–≤–∏–ª –ª–∞–π–∫ –ø–æ–¥ –≤–∞—à–∏–º –ø–æ—Å—Ç–æ–º ${postId}`;
          sendNotification(notificationData, post.author, content);
        }
      } catch (err) {
        console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –ª–∞–π–∫–∞', err);
      }
    }

    async function loadComments() {
      const commentsContainer = document.getElementById('comments');
      const t = translations[currentLang];
      try {
        const res = await fetch(`http://localhost:8084/comments/post/${postId}`, {
          credentials: 'include'
        });
        const comments = await res.json();

        if (comments.length === 0) {
          commentsContainer.innerHTML = `<p>${t.noComments}</p>`;
        } else {
          commentsContainer.innerHTML = comments.map(c => `
            <div class="comment">
              <strong>${c.author}</strong>: ${c.text}
              <button onclick="deleteComment(${c.id})">${t.delete}</button>
            </div>
          `).join('');
        }
      } catch (err) {
        console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤');
      }
    }

    async function sendComment() {
      const input = document.getElementById('commentInput');
      const text = input.value.trim();
      const username = await getCurrentUser();
      if (!text) return;

      try {
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
        await fetch(`http://localhost:8084/comments`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ text, postId: parseInt(postId) })
        });

        input.value = '';
        loadComments();

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        const notificationData = {
          type: 'COMMENT',  // –¢–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è - COMMENT
          postId: postId,
          userId: currentUser ? currentUser.id : null, // ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          commentText: text, // –¢–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
        };

        // –°–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
        const content = `${currentUser ? currentUser.name : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π'} –Ω–∞–ø–∏—Å–∞–ª –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ–¥ –≤–∞—à–∏–º –ø–æ—Å—Ç–æ–º ${postId}`;

        // –ü–æ–ª—É—á–∞–µ–º –∏–º—è –∞–≤—Ç–æ—Ä–∞ –ø–æ—Å—Ç–∞
        sendNotification(notificationData, post.author, content);

      } catch (err) {
        console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è', err);
      }
    }

    async function deleteComment(commentId) {
      try {
        await fetch(`http://localhost:8084/comments/${commentId}/post/${postId}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        loadComments();
      } catch (err) {
        console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
      }
    }

    async function deletePost() {
      if (!confirm(translations[currentLang].deletePost)) return;

      try {
        const res = await fetch(`http://localhost:8082/post/${postId}`, {
          method: 'DELETE',
          credentials: 'include'
        });

        if (res.ok) {
          alert(currentLang === 'ru' ? '–ü–æ—Å—Ç —É–¥–∞–ª—ë–Ω' : 'Post deleted');
          window.location.href = 'main.html';
        } else {
          alert(currentLang === 'ru' ? '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç' : 'Failed to delete post');
        }
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ—Å—Ç–∞');
      }
    }

    loadPost();
</script>
</body>
</html>